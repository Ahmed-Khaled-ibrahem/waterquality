#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <DHT.h>

#define WIFI_SSID "Orange-Fast"
#define WIFI_PASS "#1288534459&4274321#Aa"
#define BOT_TOKEN "8268822841:AAEaK8iGkQLZs2Ys2YViZZAABS7fkiISBNY"
#define CHAT_ID "6793782878"

const int gasPin = 33;
const int flamePin = 27;
const int buzzerPin = 13;
const int dhtPin = 23;

#define DHTTYPE DHT11
DHT dht(dhtPin, DHTTYPE);

WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

bool triggerIsLow = true;
bool lastAlarm = false;
unsigned long lastSend = 0;
unsigned long sendCooldownMs = 8000;
unsigned long printEvery = 1500;
unsigned long lastPrint = 0;

void beepOn() {
  digitalWrite(buzzerPin, HIGH);
}

void beepOff() {
  digitalWrite(buzzerPin, LOW);
}

void sendTG(const String& s) {
  if (WiFi.status() == WL_CONNECTED) {
    bot.sendMessage(CHAT_ID, s, "");
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(gasPin, INPUT);
  pinMode(flamePin, INPUT);
  pinMode(buzzerPin, OUTPUT);
  dht.begin();
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  client.setInsecure();
  while (WiFi.status() != WL_CONNECTED) { delay(300); }
  sendTG("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø¢Ù† Ø¨Ù†Ø¬Ø§Ø­!");
}


void loop() {
  if (WiFi.status() != WL_CONNECTED) { WiFi.reconnect(); }

  int gasRaw = analogRead(gasPin);
  int flameRaw = digitalRead(flamePin);
  bool gasAlarm = triggerIsLow ? (gasRaw == LOW) : (gasRaw == HIGH);
  bool flameAlarm = triggerIsLow ? (flameRaw == LOW) : (flameRaw == HIGH);
  bool alarm = gasAlarm || flameAlarm;
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  if (alarm) {
    beepOn();
  } else {
    beepOff();
  }

  if (alarm && !lastAlarm && millis() - lastSend > sendCooldownMs) {
    String msg = "ðŸš¨ ØªÙ†Ø¨ÙŠÙ‡!\n";
    if (gasAlarm) msg += "ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ³Ø±Ø¨ ØºØ§Ø²!\n";
    if (flameAlarm) msg += "ØªÙ… Ø±ØµØ¯ Ù„Ù‡Ø¨ Ø£Ùˆ Ø­Ø±ÙŠÙ‚ Ù…Ø­ØªÙ…Ù„!\n";
    if (!isnan(t)) msg += "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: " + String(t, 1) + " Â°C\n";
    if (!isnan(h)) msg += "Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: " + String(h, 0) + " %";
    sendTG(msg);
    lastSend = millis();
  }

  if (!alarm && lastAlarm && millis() - lastSend > sendCooldownMs) {
    sendTG("âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¢Ù† Ø¢Ù…Ù†Ø© ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø±.");
    lastSend = millis();
  }
  lastAlarm = alarm;

  if (millis() - lastPrint > printEvery) {
    Serial.print("ØºØ§Ø²=");
    Serial.print(gasRaw);
    Serial.print("  Ù„Ù‡Ø¨=");
    Serial.print(flameRaw);
    Serial.print("  Ø¬Ø±Ø³=");
    Serial.print(alarm ? 1 : 0);
    Serial.print("  Ø­Ø±Ø§Ø±Ø©=");
    if (!isnan(t)) Serial.print(t, 1);
    else Serial.print("NaN");
    Serial.print("  Ø±Ø·ÙˆØ¨Ø©=");
    if (!isnan(h)) Serial.print(h, 0);
    else Serial.print("NaN");
    Serial.println();
    lastPrint = millis();
  }

  delay(10);
}
