// ============================================================================
// LIBRARIES
// ============================================================================
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <OneWire.h>
#include <DallasTemperature.h>

// ============================================================================
// PIN DEFINITIONS
// ============================================================================
// Temperature Sensor (DS18B20)
#define TEMP_SENSOR_PIN     2

// Gas Sensor (MQ-7)
#define MQ7_ANALOG_PIN      A0
#define MQ7_DIGITAL_PIN     3

// Flame Sensor
#define FLAME_SENSOR_PIN    4

// Oil Leak Detection
#define RAINDROP_ANALOG_PIN A1
#define RAINDROP_DIGITAL_PIN 5
#define TOUCH_SENSOR_PIN    6

// Alert Outputs
#define BUZZER_PIN          7
#define RGB_RED_PIN         8
#define RGB_GREEN_PIN       9
#define RGB_BLUE_PIN        10

// ============================================================================
// CONSTANTS & THRESHOLDS
// ============================================================================
// Temperature Thresholds (Celsius)
#define TEMP_WARNING        80.0    // Warning temperature
#define TEMP_CRITICAL       95.0    // Critical temperature
#define TEMP_NORMAL         70.0    // Normal operating temperature

// Gas Sensor Thresholds
#define GAS_WARNING         300     // Warning level (analog value)
#define GAS_CRITICAL        500     // Critical level (analog value)

// Raindrop Sensor Thresholds (lower = more liquid detected)
#define OIL_LEAK_THRESHOLD  500     // Threshold for oil leak detection

// Timing Constants
#define SENSOR_READ_INTERVAL 1000   // Read sensors every 1 second
#define LCD_UPDATE_INTERVAL  500    // Update LCD every 500ms
#define BUZZER_BEEP_DURATION 200    // Buzzer beep duration in ms
#define DEBOUNCE_DELAY       50     // Debounce delay for digital sensors

// LCD Configuration
#define LCD_ADDRESS         0x27    // Common I2C address (try 0x3F if not working)
#define LCD_COLS            16
#define LCD_ROWS            2

// ============================================================================
// SENSOR OBJECTS
// ============================================================================
// LCD Display
LiquidCrystal_I2C lcd(LCD_ADDRESS, LCD_COLS, LCD_ROWS);

// Temperature Sensor
OneWire oneWire(TEMP_SENSOR_PIN);
DallasTemperature tempSensor(&oneWire);

// ============================================================================
// GLOBAL VARIABLES
// ============================================================================
// Sensor readings
float motorTemperature = 0.0;
int gasLevel = 0;
bool gasDetected = false;
bool flameDetected = false;
int oilLeakLevel = 0;
bool oilLeakDetected = false;
bool touchDetected = false;

// System state
enum SystemState {
  STATE_NORMAL,
  STATE_WARNING,
  STATE_CRITICAL
};
SystemState currentState = STATE_NORMAL;

// Timing variables
unsigned long lastSensorRead = 0;
unsigned long lastLCDUpdate = 0;
unsigned long lastBuzzerBeep = 0;

// Alert flags
bool temperatureAlert = false;
bool gasAlert = false;
bool flameAlert = false;
bool oilLeakAlert = false;

// Debug mode
bool debugMode = true;

// ============================================================================
// SETUP FUNCTION
// ============================================================================
void setup() {
  // Initialize Serial Communication
  Serial.begin(9600);
  Serial.println(F("========================================"));
  Serial.println(F("  CAR MONITORING SYSTEM - STARTING"));
  Serial.println(F("========================================"));
  
  // Initialize Pin Modes
  initializePins();
  
  // Initialize LCD
  initializeLCD();
  
  // Initialize Temperature Sensor
  initializeTemperatureSensor();
  
  // Startup indication
  startupSequence();
  
  Serial.println(F("System initialized successfully!"));
  Serial.println(F("========================================\n"));
  
  delay(2000);
}

// ============================================================================
// MAIN LOOP
// ============================================================================
void loop() {
  unsigned long currentMillis = millis();
  
  // Read all sensors at regular intervals
  if (currentMillis - lastSensorRead >= SENSOR_READ_INTERVAL) {
    lastSensorRead = currentMillis;
    
    readAllSensors();
    evaluateSystemState();
    printDebugInfo();
  }
  
  // Update LCD display
  if (currentMillis - lastLCDUpdate >= LCD_UPDATE_INTERVAL) {
    lastLCDUpdate = currentMillis;
    updateLCDDisplay();
  }
  
  // Handle alerts
  handleAlerts();
  
  // Update RGB LED status
  updateRGBStatus();
}

// ============================================================================
// INITIALIZATION FUNCTIONS
// ============================================================================

void initializePins() {
  Serial.println(F("Initializing pins..."));
  
  // Input pins
  pinMode(MQ7_DIGITAL_PIN, INPUT);
  pinMode(FLAME_SENSOR_PIN, INPUT);
  pinMode(RAINDROP_DIGITAL_PIN, INPUT);
  pinMode(TOUCH_SENSOR_PIN, INPUT);
  
  // Output pins
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RGB_RED_PIN, OUTPUT);
  pinMode(RGB_GREEN_PIN, OUTPUT);
  pinMode(RGB_BLUE_PIN, OUTPUT);
  
  // Set initial states
  digitalWrite(BUZZER_PIN, LOW);
  setRGBColor(0, 0, 0);  // LED off
  
  Serial.println(F("Pins initialized."));
}

void initializeLCD() {
  Serial.println(F("Initializing LCD..."));
  
  lcd.init();
  lcd.backlight();
  lcd.clear();
  
  // Display startup message
  lcd.setCursor(0, 0);
  lcd.print(F("Car Monitor"));
  lcd.setCursor(0, 1);
  lcd.print(F("Initializing..."));
  
  Serial.println(F("LCD initialized."));
}

void initializeTemperatureSensor() {
  Serial.println(F("Initializing DS18B20 temperature sensor..."));
  
  tempSensor.begin();
  
  // Check if sensor is connected
  if (tempSensor.getDeviceCount() == 0) {
    Serial.println(F("WARNING: No DS18B20 sensor found!"));
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(F("TEMP SENSOR"));
    lcd.setCursor(0, 1);
    lcd.print(F("NOT FOUND!"));
    delay(2000);
  } else {
    Serial.print(F("DS18B20 sensors found: "));
    Serial.println(tempSensor.getDeviceCount());
  }
}

void startupSequence() {
  Serial.println(F("Running startup sequence..."));
  
  // Test RGB LED
  setRGBColor(255, 0, 0);    // Red
  delay(300);
  setRGBColor(0, 255, 0);    // Green
  delay(300);
  setRGBColor(0, 0, 255);    // Blue
  delay(300);
  setRGBColor(0, 0, 0);      // Off
  
  // Test buzzer
  tone(BUZZER_PIN, 1000, 200);
  delay(300);
  tone(BUZZER_PIN, 1500, 200);
  delay(500);
  
  Serial.println(F("Startup sequence complete."));
}

// ============================================================================
// SENSOR READING FUNCTIONS
// ============================================================================

void readAllSensors() {
  readTemperatureSensor();
  readGasSensor();
  readFlameSensor();
  readOilLeakSensors();
}

void readTemperatureSensor() {
  tempSensor.requestTemperatures();
  motorTemperature = tempSensor.getTempCByIndex(0);
  
  // Check for sensor error
  if (motorTemperature == DEVICE_DISCONNECTED_C || motorTemperature < -50) {
    Serial.println(F("ERROR: Temperature sensor disconnected or error"));
    motorTemperature = -999;  // Error indicator
  }
  
  // Evaluate temperature alerts
  if (motorTemperature >= TEMP_CRITICAL) {
    temperatureAlert = true;
  } else if (motorTemperature >= TEMP_WARNING) {
    temperatureAlert = true;
  } else {
    temperatureAlert = false;
  }
}

void readGasSensor() {
  // Read analog value (0-1023)
  gasLevel = analogRead(MQ7_ANALOG_PIN);
  
  // Read digital pin (some MQ-7 modules have digital output)
  gasDetected = digitalRead(MQ7_DIGITAL_PIN) == HIGH;
  
  // Evaluate gas alerts
  if (gasLevel >= GAS_CRITICAL || gasDetected) {
    gasAlert = true;
  } else if (gasLevel >= GAS_WARNING) {
    gasAlert = true;
  } else {
    gasAlert = false;
  }
}

void readFlameSensor() {
  // Flame sensor typically outputs LOW when flame detected
  flameDetected = digitalRead(FLAME_SENSOR_PIN) == LOW;
  flameAlert = flameDetected;
}

void readOilLeakSensors() {
  // Read raindrop sensor (analog)
  oilLeakLevel = analogRead(RAINDROP_ANALOG_PIN);
  
  // Read raindrop digital pin
  bool raindropDetected = digitalRead(RAINDROP_DIGITAL_PIN) == LOW;
  
  // Read touch sensor
  touchDetected = digitalRead(TOUCH_SENSOR_PIN) == HIGH;
  
  // Oil leak detected if either sensor triggers
  oilLeakDetected = (oilLeakLevel < OIL_LEAK_THRESHOLD) || raindropDetected || touchDetected;
  oilLeakAlert = oilLeakDetected;
}

// ============================================================================
// SYSTEM STATE EVALUATION
// ============================================================================

void evaluateSystemState() {
  // Determine overall system state based on all alerts
  if (flameAlert || 
      (motorTemperature >= TEMP_CRITICAL) || 
      (gasLevel >= GAS_CRITICAL)) {
    currentState = STATE_CRITICAL;
  } 
  else if (temperatureAlert || gasAlert || oilLeakAlert) {
    currentState = STATE_WARNING;
  } 
  else {
    currentState = STATE_NORMAL;
  }
}

// ============================================================================
// DISPLAY FUNCTIONS
// ============================================================================

void updateLCDDisplay() {
  lcd.clear();
  
  switch (currentState) {
    case STATE_CRITICAL:
      displayCriticalAlert();
      break;
      
    case STATE_WARNING:
      displayWarningAlert();
      break;
      
    case STATE_NORMAL:
      displayNormalStatus();
      break;
  }
}

void displayCriticalAlert() {
  lcd.setCursor(0, 0);
  lcd.print(F("!!! CRITICAL !!!"));
  lcd.setCursor(0, 1);
  
  if (flameAlert) {
    lcd.print(F("FIRE DETECTED!"));
  } 
  else if (motorTemperature >= TEMP_CRITICAL) {
    lcd.print(F("TEMP: "));
    lcd.print(motorTemperature, 1);
    lcd.print(F("C"));
  } 
  else if (gasLevel >= GAS_CRITICAL) {
    lcd.print(F("GAS LEAK!"));
  }
}

void displayWarningAlert() {
  lcd.setCursor(0, 0);
  lcd.print(F("** WARNING **"));
  lcd.setCursor(0, 1);
  
  if (temperatureAlert) {
    lcd.print(F("Temp: "));
    lcd.print(motorTemperature, 1);
    lcd.print(F("C"));
  } 
  else if (gasAlert) {
    lcd.print(F("Gas: "));
    lcd.print(gasLevel);
  } 
  else if (oilLeakAlert) {
    lcd.print(F("Oil Leak!"));
  }
}

void displayNormalStatus() {
  // First row: Temperature
  lcd.setCursor(0, 0);
  lcd.print(F("Temp:"));
  if (motorTemperature > -50) {
    lcd.print(motorTemperature, 1);
    lcd.print(F("C"));
  } else {
    lcd.print(F("ERR"));
  }
  
  // Add status indicator
  lcd.setCursor(14, 0);
  lcd.print(F("OK"));
  
  // Second row: Gas level
  lcd.setCursor(0, 1);
  lcd.print(F("Gas:"));
  lcd.print(gasLevel);
  
  // Add other status
  lcd.setCursor(10, 1);
  if (oilLeakDetected) {
    lcd.print(F("OIL!"));
  } else {
    lcd.print(F("    "));
  }
}

// ============================================================================
// ALERT HANDLING FUNCTIONS
// ============================================================================

void handleAlerts() {
  switch (currentState) {
    case STATE_CRITICAL:
      handleCriticalAlert();
      break;
      
    case STATE_WARNING:
      handleWarningAlert();
      break;
      
    case STATE_NORMAL:
      // No alerts needed
      noTone(BUZZER_PIN);
      break;
  }
}

void handleCriticalAlert() {
  // Continuous fast beeping for critical alerts
  unsigned long currentMillis = millis();
  
  if (currentMillis - lastBuzzerBeep >= 300) {
    tone(BUZZER_PIN, 2000, 200);
    lastBuzzerBeep = currentMillis;
  }
}

void handleWarningAlert() {
  // Intermittent beeping for warnings
  unsigned long currentMillis = millis();
  
  if (currentMillis - lastBuzzerBeep >= 1000) {
    tone(BUZZER_PIN, 1500, 300);
    lastBuzzerBeep = currentMillis;
  }
}

// ============================================================================
// RGB LED FUNCTIONS
// ============================================================================

void updateRGBStatus() {
  switch (currentState) {
    case STATE_CRITICAL:
      // Blinking red for critical
      if (millis() % 500 < 250) {
        setRGBColor(255, 0, 0);  // Red
      } else {
        setRGBColor(0, 0, 0);    // Off
      }
      break;
      
    case STATE_WARNING:
      setRGBColor(255, 165, 0);  // Orange/Yellow
      break;
      
    case STATE_NORMAL:
      setRGBColor(0, 255, 0);    // Green
      break;
  }
}

void setRGBColor(int red, int green, int blue) {
  analogWrite(RGB_RED_PIN, red);
  analogWrite(RGB_GREEN_PIN, green);
  analogWrite(RGB_BLUE_PIN, blue);
}

// ============================================================================
// DEBUG FUNCTIONS
// ============================================================================

void printDebugInfo() {
  if (!debugMode) return;
  
  Serial.println(F("\n========== SENSOR READINGS =========="));
  Serial.print(F("Timestamp: "));
  Serial.print(millis() / 1000);
  Serial.println(F(" seconds"));
  
  // Temperature
  Serial.print(F("Motor Temperature: "));
  if (motorTemperature > -50) {
    Serial.print(motorTemperature, 2);
    Serial.print(F("Â°C"));
    if (temperatureAlert) {
      if (motorTemperature >= TEMP_CRITICAL) {
        Serial.print(F(" [CRITICAL]"));
      } else {
        Serial.print(F(" [WARNING]"));
      }
    } else {
      Serial.print(F(" [NORMAL]"));
    }
  } else {
    Serial.print(F("ERROR - Sensor disconnected"));
  }
  Serial.println();
  
  // Gas Sensor
  Serial.print(F("Gas Level (MQ-7): "));
  Serial.print(gasLevel);
  Serial.print(F(" | Digital: "));
  Serial.print(gasDetected ? F("DETECTED") : F("CLEAR"));
  if (gasAlert) {
    if (gasLevel >= GAS_CRITICAL) {
      Serial.print(F(" [CRITICAL]"));
    } else {
      Serial.print(F(" [WARNING]"));
    }
  } else {
    Serial.print(F(" [NORMAL]"));
  }
  Serial.println();
  
  // Flame Sensor
  Serial.print(F("Flame Sensor: "));
  Serial.print(flameDetected ? F("FIRE DETECTED!") : F("No fire"));
  if (flameAlert) {
    Serial.print(F(" [CRITICAL]"));
  }
  Serial.println();
  
  // Oil Leak Detection
  Serial.print(F("Oil Leak - Raindrop: "));
  Serial.print(oilLeakLevel);
  Serial.print(F(" | Touch: "));
  Serial.print(touchDetected ? F("TOUCHED") : F("Not touched"));
  Serial.print(F(" | Status: "));
  Serial.print(oilLeakDetected ? F("LEAK DETECTED") : F("No leak"));
  if (oilLeakAlert) {
    Serial.print(F(" [WARNING]"));
  }
  Serial.println();
  
  // System State
  Serial.print(F("\nSystem State: "));
  switch (currentState) {
    case STATE_CRITICAL:
      Serial.println(F("CRITICAL"));
      break;
    case STATE_WARNING:
      Serial.println(F("WARNING"));
      break;
    case STATE_NORMAL:
      Serial.println(F("NORMAL"));
      break;
  }
  
  Serial.println(F("=====================================\n"));
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

// Function to get string representation of system state
String getStateString() {
  switch (currentState) {
    case STATE_CRITICAL:
      return "CRITICAL";
    case STATE_WARNING:
      return "WARNING";
    case STATE_NORMAL:
      return "NORMAL";
    default:
      return "UNKNOWN";
  }
}

// Function to manually test all components (can be called from Serial commands)
void testAllComponents() {
  Serial.println(F("\n========== TESTING ALL COMPONENTS =========="));
  
  // Test buzzer
  Serial.println(F("Testing buzzer..."));
  tone(BUZZER_PIN, 1000, 500);
  delay(700);
  
  // Test RGB LED
  Serial.println(F("Testing RGB LED..."));
  setRGBColor(255, 0, 0);
  delay(500);
  setRGBColor(0, 255, 0);
  delay(500);
  setRGBColor(0, 0, 255);
  delay(500);
  setRGBColor(0, 0, 0);
  
  // Test LCD
  Serial.println(F("Testing LCD..."));
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print(F("Component Test"));
  lcd.setCursor(0, 1);
  lcd.print(F("All Systems"));
  delay(2000);
  
  Serial.println(F("Component test complete!"));
  Serial.println(F("============================================\n"));
}
