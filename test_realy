import socket
import csv
import time
from datetime import datetime

# UDP settings
UDP_IP = "0.0.0.0"  # Listen on all interfaces
UDP_PORT = 12345

# CSV file setup
CSV_FILE = "sensor_data.csv"

# Create CSV file with headers if it doesn't exist
with open(CSV_FILE, mode='a', newline='') as file:
    writer = csv.writer(file)
    if file.tell() == 0:  # File is empty
        writer.writerow(["Timestamp", "Temperature (C)", "Humidity (%)", "UV Index"])

# Set up UDP socket
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind((UDP_IP, UDP_PORT))

print("Listening for sensor data...")

while True:
    try:
        # Receive data
        data, addr = sock.recvfrom(1024)
        data_str = data.decode()

        # Parse data
        temp, hum, uv = map(float, data_str.split(','))

        # Get current timestamp
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # Display data
        print(f"{timestamp} | Temp: {temp}Â°C, Humidity: {hum}%, UV Index: {uv}")

        # Write to CSV
        with open(CSV_FILE, mode='a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([timestamp, temp, hum, uv])

    except Exception as e:
        print("Error:", e)
